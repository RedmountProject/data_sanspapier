var fillLoginForm=function(a){$("#form").html(a);$("#form").append('<div><span id="forgotPasswordForm">mot-de-passe oublié ?</span></div>');$("#form").append('<div><span id="registerForm">créer un compte</span></div>');$("#registerForm").click(function(){AjaxController.getRegisterForm(fillRegisterForm)});$("#forgotPasswordForm").click(function(){AjaxController.getPasswordResetterForm(fillForgotPasswordForm)})};var fillRegisterForm=function(a){$("#form").html(a);$("#form").append('<div id="loginForm"><span>Retour</span></div>');$("#loginForm").click(function(){AjaxController.getLoginForm(fillLoginForm)})};var fillForgotPasswordForm=function(a){$("#form").html(a);$("#form").append('<div id="loginForm"><span>Retour</span></div>');$("#loginForm").click(function(){AjaxController.getLoginForm(fillLoginForm)})};var connected=function(a){$("#form").html(a);$("#logout").click(function(){AjaxController.logOut();$("#form").html('<p style="font-size:16px; font-weight: bold; position:relative; float: right; margin:10px;">Déconnecté</p>')});$("#perso").click(function(){window.location=window.sanspapier.config.front_url+"profile.html"})};var bindClickHandlers=function(){$("#loginForm").click(function(){AjaxController.getLoginForm(fillLoginForm)});$("#registerForm").click(function(){AjaxController.getRegisterForm(fillRegisterForm)});$("#forgotPasswordForm").click(function(){AjaxController.getPasswordResetterForm(fillForgotPasswordForm)})};var hideHandlers=function(){$("#loginForm").hide();$("#registerForm").hide();$("#forgotPasswordForm").hide()};var showHandlers=function(){$("#loginForm").show();$("#registerForm").show();$("#forgotPasswordForm").show()};var userForm=function(){$("#mon_compte").qtip({content:{text:"Connectez vous pour accéder à votre espace perso"},show:{event:true,target:$("#mon_compte")},hide:{fixed:true,delay:600},position:{at:"bottom right",my:"top right",adjust:{}},style:{classes:"windows",tip:{corner:false}},events:{show:function(b,a){$.fn.qtip.zindex=1000}}})};
var deleteElementFromCart=function(){$(".delete_cartElement").each(function(){var a=($(this).attr("id")).split("_")[1];$(this).click(function(){AjaxController.removeElementFromCart(a)})})};var endSelec=function(){$("#end_button").click(function(){alert("Bientôt disponible...")})};
function createCartResults(b){var e=window.sanspapier.config;var d="";var f=b.EUR_c.slice(0,5);var a="";for(var c=0;c<b.format_name.length;c++){if(c==b.format_name.length-1){a+=b.format_name[c].split("_")[1]}else{a+=b.format_name[c].split("_")[1]+", "}}d='<div class="cart_container">\n                        <div class="cartElement_container" id="cart_'+b+'">\n                            <a href="#'+b.product_id+'" class="delete_cartElement" id="#cart_'+b.product_id+'"><img src="http://grammezero.com/images/icons/delete.png" /></a>\n                            <div class="cartElement_image"><img src="'+e.images_url+b.product_id+"/"+b.product_id+'_fc_E.jpg"/></div>\n                            <div class="cartElement_title">'+b.title+'</div>\n                            <div class="cartElement_author">'+b.author_firstname[0]+" "+b.author_lastname[0]+'</div>\n                            <div class="cartElement_publisher">'+b.publisher_name+'</div>\n                            <div class="cartElement_price">'+f+'€</div>\n                            <div class="cartElement_format">'+a+"</div>\n                            </div>\n                        </div>";return d}function displayProductsShelf(f){var b=window.sanspapier.config;var l="";console.log(f);var f=f.products;var m=f.links;console.log(m);for(var g=0;g<f.length;g++){var c=f[g][0]["EUR_c"].slice(0,5);var h=[];var a="";for(var d=0;d<f[g][0]["format_name"].length;d++){h.push(f[g][0]["format_name"][d].split("_")[1])}for(var e=0;e<h.length;e++){a+='<div class="shelfElement_multipleFormats">'+h[e]+'</div>\n                                    <a href="#dwnldLink_'+f[g][0]["product_id"]+"_"+h[e]+'" class="shelfElement_dwnldLink id="dwnldLink_'+f[g][0]["product_id"]+"_"+h[e]+'">Télécharger</a>'}l+='<div class="shelfElement_container" id="shelf_'+f[g][0]["product_id"]+'">\n                    <a href="#" class="bookSheetIdLink shelfElement_image"><img tooltip="'+f[g][0]["product_id"]+'" src="'+b.images_url+f[g][0]["product_id"]+"/"+f[g][0]["product_id"]+'_fc_E.jpg"/></a>\n                    <div class="shelfElement_price">'+c+'€</div>\n                    <div class="shelfElement_title">'+f[g][0]["title"]+'</div>\n                    <div class="shelfElement_author">'+f[g][0]["author_firstname"][0]+" "+f[g][0]["author_lastname"][0]+'</div>\n                    <div class="shelfElement_publisher">'+f[g][0]["publisher_name"]+'</div>\n                    <div class="shelfElement_format">'+a+"</div>\n                 </div>"}return l};
var init_obj={html:{achats_html:""},top:0,logged:false};obcat(window.sanspapier,init_obj);window.onload=function(){AjaxController.getOperationStatus();AjaxController.init_is_logged();$("#mon_compte").click(function(){AjaxController.is_logged()});context()};
var AjaxController=(function(){var c=window.sanspapier.html;var b=window.sanspapier.config.data_url;var a={logOut:function(){var d=b+"profile/ajax_logout.json";$.ajax({url:d,dataType:"json",complete:function(){},success:function(){console.log("logout")},error:function(){console.log("logout error")}})},is_logged:function(){var d=b+"profile/ajax_is_logged.json";$.ajax({url:d,dataType:"json",complete:function(){},success:function(e){if(e.status==false){userForm();$("#mon_compte").qtip("show")}else{if(e.status==true){window.location=window.sanspapier.config.front_url+"profile.html"}}},error:function(){}})},init_is_logged:function(){var d=b+"profile/ajax_is_logged.json";$.ajax({url:d,dataType:"json",complete:function(e){},success:function(e){if(e.status==false){$("#id").animate({opacity:1,color:"white"});$("#shop_cartDisplay").css({display:"none"});AjaxController.getLoginForm(fillLoginForm)}else{if(e.status==true){AjaxController.isComplete()}}},error:function(){console.log("is logged ajax_error")}})},isComplete:function(){var d=b+"profile/preferences/is_complete.json";$.ajax({url:d,dataType:"json",complete:function(){},success:function(e){if(e.status==false){AjaxController.getPreferencesForm(fillPrefForm);$("#id").animate({opacity:1,color:"white"})}else{$("#shop_cartDisplay").css({display:"block"});$("#form").hide(0);$("#id").animate({opacity:1,color:"green"},200);$("#selec").animate({opacity:1,color:"white"});AjaxController.cart_display("");$("#total_price").show()}},error:function(){}})},getLoginForm:function(e){var d=b+"login";$.ajax({url:d,dataType:"html",complete:function(){},success:function(f){e(f)},error:function(){console.log("login form ajax_error")}})},getRegisterForm:function(e){var d=b+"register";$.ajax({url:d,dataType:"html",complete:function(){},success:function(f){e(f)},error:function(){console.log("register form ajax_error")}})},getPasswordResetterForm:function(e){var d=b+"resetting/request";$.ajax({url:d,dataType:"html",complete:function(){},success:function(f){e(f)},error:function(){console.log("password resetter ajax_error")}})},getPreferencesForm:function(e){var d=b+"profile/preferences/form";$.ajax({url:d,dataType:"html",complete:function(){},success:function(f){e(f)},error:function(){console.log("pref from ajax_error")}})},prefIsComplete:function(){var d=b+"profile/preferences/is_complete.json";$.ajax({url:d,dataType:"json",complete:function(){},success:function(){$("#form").hide(100);$("#id").animate({opacity:1,color:"green"},200);$("#selec").animate({opacity:1,color:"white"});AjaxController.cart_display("");$("#total_price").show()},error:function(){}})},cart_display:function(e){var d=b+"profile/cart/get_cart.json";$.ajax({url:d,dataType:"json",complete:function(){deleteElementFromCart();endSelec()},success:function(j){var g="";if(j.status==true){for(var f=0;f<j.data["products"].length;f++){g=g+createCartResults(j.data["products"][f])}$("#shop_cartDisplay").html(e+"<br>"+g);var h=(j.data["total_price"]).toString();$("#_price").html(h.slice(0,5)+"€")}else{$("#shop_cartDisplay").html('<p style="font-weight:bold; font-size:18px; margin:10px;">panier vide</p>');$("#total_price").hide(100)}},error:function(){console.log("ajax_error")}})},removeElementFromCart:function(d){var e=b+"profile/cart/delete_from_cart_"+d+".json";$.ajax({url:e,dataType:"json",complete:function(){},success:function(f){AjaxController.cart_display("")},error:function(){}})},getPaymentForm:function(){var h=$(location).attr("protocol");var f=$(location).attr("host");var e=f;var d=encodeURIComponent(e);var g=b+"shop/secure/request.html/"+d;$.ajax({url:g,dataType:"html",complete:function(){},success:function(i){$("#selec_step").hide();$("#selec").animate({opacity:1,color:"green"},200);$("#pay").animate({opacity:1,color:"white"});$("#payment_step").html(i);$("#payment_step").animate({opacity:1},300)},error:function(){}})},download:function(e){var d=b+"profile/getProductsShelf.json";$.ajax({url:d,dataType:"json",complete:function(){$("#id").animate({opacity:1,color:"green"},200,function(){$("#selec").animate({opacity:1,color:"green"});$("#pay").animate({opacity:1,color:"green"})});$("#download_step").html(c.achats_html);AjaxController.emptyCart()},success:function(f){$("#form").hide();$("#selec_step").hide();$("#payment_step").hide();$("#download_step").show(300);console.log(f);if(f.products["products"].length!=0){c.achats_html=e+"<h1>Mes achats</h1>"+displayProductsShelf(f.products)}else{c.achats_html="<h1>Mes achats</h1>"}},error:function(){}})},emptyCart:function(e){var f=b+"profile/cart/clear_cart.json";var d=e;$.ajax({url:f,dataType:"json",complete:function(){},success:function(){},error:function(){console.log("ajax_error")}})},getOperationStatus:function(){var d=b+"shop/secure/checkId.json";$.ajax({url:d,dataType:"json",complete:function(){},success:function(e){console.log(e);switch(e){case 3:$("#download").animate({opacity:1,color:"green"});$("#payment_step").html(e);$("#payment_step").animate({opacity:1},300);AjaxController.download("<p>Merci pour votre commande.</p>");break;case 2:$("#download").animate({opacity:1,color:"white"});$("#payment_step").html(e);$("#payment_step").animate({opacity:1},300);AjaxController.download("<p style='color: #AA0000'>Problème Dilicom</p>");break;case 1:AjaxController.cart_display("<p style='color: #AA0000'>Paiement refusé</p>");break}},error:function(){}})}};return a})();