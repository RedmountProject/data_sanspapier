var fillLoginForm=function(a){$("#infos_perso").html('<p style="font-size:20px; text-decoration: underline; margin-bottom: 20px; padding:5px;">Identifiez-vous</p>'+a);$("#infos_perso").append('<div><span id="forgotPasswordForm">mot-de-passe oublié ?</span></div>');$("#infos_perso").append('<div><span id="registerForm">créer un compte</span></div>');$("#registerForm").click(function(){AjaxController.getRegisterForm(fillRegisterForm)});$("#forgotPasswordForm").click(function(){AjaxController.getPasswordResetterForm(fillForgotPasswordForm)})};var fillRegisterForm=function(a){$("#infos_perso").html(a);$("#infos_perso").append('<div><span id="loginForm">s\'identifier</span></div>');$("#loginForm").click(function(){AjaxController.getLoginForm(fillLoginForm)})};var fillForgotPasswordForm=function(a){$("#infos_perso").html(a);$("#infos_perso").append('<div><span id="loginForm">s\'identifier</span></div>');$("#loginForm").click(function(){AjaxController.getLoginForm(fillLoginForm)})};
var conf={achats_html:"",infos_html:"",mdp_html:"",};obcat(window.sanspapier.config,conf);window.onload=function(){$("#return").click(function(){window.location=window.sanspapier.config.front_url+"search.html"});AjaxController.is_logged();AjaxController.mes_achats();context();cart_tooltip();refreshCart()};
function displayProductsShelf(l){var c=window.sanspapier.config;var n="";for(var g=0;g<l.length;g++){var o=l[g];var b=o.product[0];var d=b.EUR_c.slice(0,5);var m=[];for(var e=0;e<o.links.length;e++){m.push(o.links[e])}var a="";for(var f=0;f<m.length;f++){var h=b.format_name[0].split("_")[1];a+='<div class="shelfElement_multipleFormats">'+h+'</div>\n                                    <a href="'+m[f]["url"]+'" target="_blank" class="shelfElement_dwnldLink id="dwnldLink_'+b.product_id+"_"+m[f]+'"><div id="telecharger"></div></a>'}n+='<div class="shelfElement_container" id="shelf_'+b.product_id+'">\n                    <a href="#" class="bookSheetIdLink shelfElement_image"><img tooltip="'+b.product_id+'" src="'+c.images_url+b.product_id+"/"+b.product_id+'_fc_E.jpg"/></a>\n                    <div class="shelfElement_price">'+d+'€</div>\n                    <div class="shelfElement_title">'+b.title+'</div>\n                    <div class="shelfElement_author">'+b.author_firstname[0]+" "+b.author_lastname[0]+'</div>\n                    <div class="shelfElement_publisher">'+b.publisher_name+'</div>\n                    <div class="shelfElement_format">'+a+"</div>\n                 </div>"}return n}function createCartResults(a){var e=window.sanspapier.config;var f="";if(a.author_firstname!==undefined){f=a.author_firstname[0]+" "}else{f=""}var d=a.EUR_c.slice(0,4);var b="#!booksheet|"+fixedEncodeURIComponent(a.product_id);var c='<div class="cart_container">\n                            <div class="cartElement_container" id="cart_'+a.product_id+'">\n                                <a href="'+b+'" class="cartElement_image bookSheetIdLink" id="cartBooksheet_'+a.product_id+'" title="Obtenir plus d\'infos sur ce livre"><img tooltip="'+a.product_id+'" src="'+e.images_url+a.product_id+"/"+a.product_id+'_fc_E.jpg"/></a>\n                                <a href="'+b+'" class="cartElement_title bookSheetIdLink" id="linkTitleBiblio_'+a.product_id+'" tooltip="'+a.product_id+'">'+a.title+'</a>\n                                <div class="cartElement_author">'+f+a.author_lastname[0]+'</div>\n                                <div class="cartElement_publisher">'+a.publisher_name+'</div>\n                                <div class="cartElement_price">'+d+' €</div>\n                                <a href="#'+a.product_id+'" class="delete_cartElement" id="#cart_'+a.product_id+'"><img src="http://grammezero.com/images/icons/delete.png" /></a>\n                            </div>\n                        </div>';return c}function fillCartDom(a){$("#panier_display").html(a)};
var AjaxController=(function(){var c=window.sanspapier.config;var b=window.sanspapier.config.data_url;var a={is_logged:function(){$.ajax({url:b+"profile/ajax_is_logged.json",dataType:"json",complete:function(){},success:function(d){if(d.status==false){window.location=window.sanspapier.config.front_url+"search.html";alert("Connectez-vous afin de pouvoir accéder à votre espace perso. Cliquez sur 'Mon compte'.")}else{$("#mes_achats").show(500);$("#infos_perso").show(500,function(){AjaxController.infos_perso()})}},error:function(){console.log("ajax_error")}})},getLoginForm:function(e){var d=b+"login";$.ajax({url:d,dataType:"html",complete:function(){},success:function(f){e(f)},error:function(){console.log("login form ajax_error")}})},getPasswordResetterForm:function(e){var d=b+"resetting/request";$.ajax({url:d,dataType:"html",complete:function(){},success:function(f){e(f)},error:function(){console.log("password resetter ajax_error")}})},createAcount:function(d){$.ajax({url:b+"register",dataType:"html",complete:function(){},success:function(e){console.log(e);d(e)},error:function(){}})},getRegisterForm:function(e){var d=b+"register";$.ajax({url:d,dataType:"html",complete:function(){},success:function(f){e(f)},error:function(){console.log("register form ajax_error")}})},getPasswordResetterForm:function(e){var d=b+"resetting/request";$.ajax({url:d,dataType:"html",complete:function(){},success:function(f){e(f)},error:function(){console.log("password resetter ajax_error")}})},infos_perso:function(){$.ajax({url:b+"profile/preferences/form",dataType:"html",complete:function(){AjaxController.modif_mdp()},success:function(d){c.infos_html="<h1>Mes informations personnelles</h1>"+d},error:function(){console.log("ajax_error")}})},modif_mdp:function(){$.ajax({url:b+"profile/change_password/",dataType:"html",complete:function(){$("#infos_perso").html(c.infos_html+c.mdp_html)},success:function(d){c.mdp_html=d},error:function(){console.log("ajax_error")}})},prefIsComplete:function(){var d=b+"profile/preferences/is_complete.json";$.ajax({url:d,dataType:"json",complete:function(){},success:function(){},error:function(){}})},mes_achats:function(){var d=b+"profile/getProductsShelf.json";$.ajax({url:d,dataType:"json",complete:function(){$("#mes_achats").html(c.achats_html)},success:function(e){console.log(e);if(e.products.length!=0){c.achats_html="<h1>Mes achats</h1>"+displayProductsShelf(e.products)}else{c.achats_html='<h1>Mes achats</h1><p style="margin: 10px;">Aucune commande enregistrée</p>'}},error:function(){}})},bookSheet:function(d){var e=b+"books/sheet_"+d+".json";$.ajax({url:e,dataType:"json",complete:function(){$(document.body).qtip("option","content.text",$("#booksheet").clone());var f=new spSlider("editions_slider",500,100,window.sanspapier.booksheet.nb_otherEditors);var g=new spSlider("auteur_slider",500,100,window.sanspapier.booksheet.nb_sameAuthor);add_to_cart();update_bookSheet_targets()},success:function(f){parseJsonForBookSheet(f,"booksheet");window.sanspapier.booksheet.nb_sameAuthor=f.sameAuthor.length-1;window.sanspapier.booksheet.nb_otherEditors=f.otherEditors.length-1},error:function(){console.log("booksheet ajax_error")}})},removeElementFromCart:function(d,i){var e=window.sanspapier.config.front_url;var f=b+"profile/cart/delete_from_cart_"+d+".json";var j="";var h="";var g=i;$.ajax({url:f,dataType:"json",complete:function(){},success:function(k){$.ajax({url:b+"profile/cart/get_cart.json",dataType:"json",complete:function(){},success:function(m){if(m.status==true){for(var l=0;l<m.data["products"].length;l++){h=h+createCartResults(m.data["products"][l])}j=h+'<div class="total_price">Total: '+m.data["total_price"]+'€</div><a href="'+e+'shop.html" class="endCart" id="processCart"><img src="http://grammezero.com/images/icons/finish.png" /></a>';fillCartDom(j);i.set("content.text",$("#panier_display"));$("#cart").qtip("render")}else{j="panier vide";fillCartDom(j);i.set("content.text",$("#panier_display"));$("#cart").qtip("render")}deleteElementFromCart(i)},error:function(){console.log("ajax_error")}});if(k.status==true){animateCart(k.numOfItems)}},error:function(){console.log("ajax_error")}})}};return a})();
var booksheet_tooltip=function(){var a=$(".bookSheetIdLink").each(function(){var b=($(this).attr("id")).split("_")[1];$.attr(this,"tooltip",b)});$(document.body).qtip({content:{text:$("#modal_loading").clone()},position:{target:$(window),my:"center",at:"center"},show:{target:a,event:"click",modal:{on:true,blur:true}},hide:{target:a,event:"unfocus"},style:{classes:"windows"},events:{show:function(c,b){update_bookSheet_targets();$.fn.qtip.zindex=15000;b.set("content.text",$("#modal_loading").clone());var e=$(c.originalEvent.target);var d=e.attr("tooltip");AjaxController.bookSheet(d)}}})};var update_bookSheet_targets=function(){var a=$(".bookSheetIdLink").each(function(){});$(document.body).qtip("option","show.target",a);$(document.body).qtip("render")};var update_booksheet_close_target=function(){var a=$("#booksheet .buy_button").each(function(){});$(document.body).qtip("option","hide.target",a);$(document.body).qtip("render")};var cart_tooltip=function(){var b=window.sanspapier.config.data_url;var a=window.sanspapier.config.front_url;var c="";$("#cart").qtip({content:{text:"Chargement...",ajax:{url:b+"profile/cart/get_cart.json",type:"GET",dataType:"json",once:false,complete:function(){deleteElementFromCart(this)},success:function(f){console.log(f);var e="";if(f.status==true){for(var d=0;d<f.data["products"].length;d++){c+=createCartResults(f.data["products"][d])}e=c+'<div class="total_price">Total: '+f.data["total_price"]+' €</div><a href="'+a+'shop.html" class="endCart" id="processCart"><img src="http://grammezero.com/images/icons/finish.png" /></a>';fillCartDom(e);this.set("content.text",$("#panier_display"));$("#cart").qtip("render")}else{e="panier vide";fillCartDom(e);this.set("content.text",$("#panier_display"));$("#cart").qtip("render")}c=""},error:function(){console.log("ajax error")}}},show:{event:"click"},hide:{event:"mouseleave",fixed:true,delay:400},position:{target:$("#cart"),at:"bottom right",my:"top right",adjust:{x:18}},style:{classes:"windows",tip:{corner:false}},events:{show:function(f,d){$.fn.qtip.zindex=20000}}})};var deleteElementFromCart=function(b){var a=b;$(".delete_cartElement").each(function(){var c=($(this).attr("id")).split("_")[1];$.attr(this,"tooltip",c);$(this).click(function(){$("#cart_"+c).animate({height:"0px",opacity:0},100,function(){AjaxController.removeElementFromCart(c,b)})})})};var animateCart=function(a){$("#cart").animate({opacity:0},50,function(){$("#cart").animate({opacity:0.7},100)});$("#cartCount").animate({opacity:0},50,function(){$("#cartCount").animate({opacity:1},100)});if(a==0){$("#cartCount").html("")}else{$("#cartCount").html("("+a+")")}};var refreshCart=function(){var a=window.sanspapier.config.data_url;$.ajax({url:a+"profile/cart/count_cart.json",dataType:"json",complete:function(){},success:function(b){if(b==0){$("#cartCount").html("")}else{$("#cartCount").html("("+b+")")}},error:function(){console.log("ajax_error")}})};var moreText=function(){$(".text").css({"overflow-y":"scroll"});$(".text").html(window.sanspapier.booksheet.fullText);addBlank(".text")};